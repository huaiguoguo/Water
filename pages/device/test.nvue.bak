<template>
	<view>
		<view class="page-body">
			<view class="page-section page-section-gap">
				<map id="navmap" ref="map1" style="width: 100%; height: 300px;" :enable-zoom="enableZoom" :polyline='polyline' :latitude="latitude" :longitude="longitude" scale="17"
				 :markers=markers show-location="true" @markertap="markertap">
				</map>
			</view>
		</view>
	</view>
</template>

<script>
	import AMapLoader from '@amap/amap-jsapi-loader';
	export default {
		data() {
			return {
				markers: [],
				poisdatas: [],
				title: 'map',
				map: null,
                enableZoom: true,
				latitude: 34.789689,
				longitude: 113.698686,
				SRC: '111111111111',
				polyline: [{
					points: [{
							latitude: 34.789689,
							longitude: 113.698686,
						},
						{
							latitude: 34.789689,
							longitude: 113.698686,
						},
					],
					color: "#00ff22",
					width: 200,
					dottedLine: true,
					arrowLine: true,
				}],
			}
		},
		onReady(options) {
			console.log('-===============START');
			// var nmap = uni.createMapContext("navmap",this);
			// console.log(nmap);
			console.log('-===============END');
		},
		onLoad() {
			
			
			this.getAMap();
			
			var that = this;
			var amapFile = require('../../static/map.js');
			var amapPlugin = new amapFile.AMapWX({
				// key: "d79175a7297ea981b65a7bb9dae0fec2"
				key: ""
			});
			amapPlugin.getPoiAround({
				success: function(data) {
					//成功回调
					that.markers = data.markers;
					that.markers = [{
						"id": 19,
						"width": 100,
						"height": 100,
						"latitude": 34.789689,
						"longitude": 113.698686,
						"callout": {
							"padding": 2,
							"fontSize": 15,
							"bgColor": "#ccc",
							"color": "#6B8E23",
							"borderRadius": 5,
							"display": "BYCLICK",
							"content": "中南宿舍"
						}
					}, {
						"id": 18,
						"width": 100,
						"height": 100,
						"latitude": 34.889689,
						"longitude": 113.798686,
						"callout": {
							"padding": 2,
							"fontSize": 15,
							"bgColor": "blue",
							"color": "#6B8E23",
							"borderRadius": 5,
							"display": "BYCLICK",
							"content": "北京德和衡(杭州)律师事务所"
						}
					}];
					console.log('=========ttt');
					// console.log(data.poisData);

					that.poisdatas = data.poisData;
					var markers_new = [];
					that.markers.forEach(function(item, index) {
						markers_new.push({
							id: item.id, //marker 序号
							width: item.width, //marker 宽度
							height: item.height, //marker 高度
							iconPath: item.iconPath, //marker 图标路径
							latitude: item.latitude, //marker  纬度
							longitude: item.longitude, //marker 经度
							callout: {
								padding: 2, //callout 文本边缘留白
								fontSize: 25, //callout  文字大小
								bgColor: 'blue', //callout 背景颜色
								color: '#6B8E23', //callout 文字颜色
								borderRadius: 5, //边框圆角
								display: 'BYCLICK', //callout 'BYCLICK':点击显示; 'ALWAYS':常显
								content: "<view style='width:75rpx; height: 60rpx;'>"+that.poisdatas[index].name+"</view>" //地理位置名称
							}
						})
					})
					that.markers = markers_new;
					// console.log("data", JSON.stringify(that.poisdatas));
					console.log("markers", JSON.stringify(that.markers));
				},
				fail: function(info) {
					//失败回调
					console.log("info", info)
				}
			});
			amapPlugin.getStaticmap({
				zoom: 8,
				size: 300 * 300,
				scale: 2,
				paths: "10,0x0000ff,1,,:120.210890,30.207171;120.210205,30.207968;120.210320,,30.207599;120.210694,30.207111",
				success: function(data) {
					that.SRC = data.url;
				},
				fail: function(info) {
					wx.showModal({
						title: info.errMsg
					})
				}
			})


		},
		methods: {
			markertap: function(e) {
				console.log(e.target);
				for (var i = 0; i < this.markers.length; i++) {
					if (JSON.stringify(e).substring(18, 20) == this.markers[i].id) {
						console.log("markers" + this.poisdatas[i].name + "   " + this.poisdatas[i].address);
						
					}
					
					uni.showToast({
						title: this.poisdatas[i].name,
						mask: true,
						duration: 1500
					});
				}
			},
			getAMap:function(){
				AMapLoader.load({
				    key: "04af9fa6750c53530d457852d67b4656",
				    version: "1.4.15",   // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15
				    plugins: [],           // 需要使用的的插件列表，如比例尺'AMap.Scale'等
				    AMapUI: {             // 是否加载 AMapUI，缺省不加载
				        version: '1.1',   // AMapUI 缺省 1.1
				        plugins:[],       // 需要加载的 AMapUI ui插件
				    },
				    Loca:{                // 是否加载 Loca， 缺省不加载
				        version: '1.3.2'  // Loca 版本，缺省 1.3.2
				    },
				}).then((AMap)=>{
				    this.map = new AMap.Map('container');
				}).catch(e => {
				    console.log(e);
				})
			}
		}
	}
</script>

<style>
</style>
